From d31e6673bff0b2b062af359e7900812b472aa492 Mon Sep 17 00:00:00 2001
From: Colin Watson <cjwatson@ubuntu.com>
Date: Mon, 13 Jan 2014 12:13:30 +0000
Subject: Add configure option to use vt.handoff=1
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This is used for non-recovery Linux entries only; it enables
flicker-free booting if gfxpayload=keep is in use and a suitable kernel
is present.

Recently modified by ≈Åukasz 'sil2100' Zemczak to do a vt.handoff=1 instead
of vt.handoff=7.

Author: Andy Whitcroft <apw@canonical.com>
Forwarded: not-needed
Last-Update: 2019-06-05

Patch-Name: vt_handoff.patch
---
 configure.ac                | 11 +++++++++++
 util/grub.d/10_linux.in     | 28 +++++++++++++++++++++++++++-
 util/grub.d/10_linux_zfs.in | 28 +++++++++++++++++++++++++++-
 3 files changed, 65 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index 7f1431352..cd1f49837 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1863,6 +1863,17 @@ else
 fi
 AC_SUBST([GFXPAYLOAD_DYNAMIC])
 
+AC_ARG_ENABLE([vt-handoff],
+              [AS_HELP_STRING([--enable-vt-handoff],
+                              [use Linux vt.handoff option for flicker-free booting (default=no)])],
+              [], [enable_vt_handoff=no])
+if test x"$enable_vt_handoff" = xyes ; then
+  VT_HANDOFF=1
+else
+  VT_HANDOFF=0
+fi
+AC_SUBST([VT_HANDOFF])
+
 LIBS=""
 
 AC_SUBST([FONT_SOURCE])
diff --git a/util/grub.d/10_linux.in b/util/grub.d/10_linux.in
index 0b402503a..5a2a57b0e 100644
--- a/util/grub.d/10_linux.in
+++ b/util/grub.d/10_linux.in
@@ -24,6 +24,7 @@ ubuntu_recovery="@UBUNTU_RECOVERY@"
 quiet_boot="@QUIET_BOOT@"
 quick_boot="@QUICK_BOOT@"
 gfxpayload_dynamic="@GFXPAYLOAD_DYNAMIC@"
+vt_handoff="@VT_HANDOFF@"
 
 . "$pkgdatadir/grub-mkconfig_lib"
 
@@ -98,6 +99,14 @@ if [ "$ubuntu_recovery" = 1 ]; then
     GRUB_CMDLINE_LINUX_RECOVERY="$GRUB_CMDLINE_LINUX_RECOVERY nomodeset"
 fi
 
+if [ "$vt_handoff" = 1 ]; then
+  for word in $GRUB_CMDLINE_LINUX_DEFAULT; do
+    if [ "$word" = splash ]; then
+      GRUB_CMDLINE_LINUX_DEFAULT="$GRUB_CMDLINE_LINUX_DEFAULT \$vt_handoff"
+    fi
+  done
+fi
+
 linux_entry ()
 {
   os="$1"
@@ -143,7 +152,7 @@ linux_entry ()
   fi
   if ([ "$ubuntu_recovery" = 0 ] || [ x$type != xrecovery ]) && \
      ([ "x$GRUB_GFXPAYLOAD_LINUX" != x ] || [ "$gfxpayload_dynamic" = 1 ]); then
-      echo "	set gfxpayload=\$linux_gfx_mode" | sed "s/^/$submenu_indentation/"
+      echo "	gfxmode \$linux_gfx_mode" | sed "s/^/$submenu_indentation/"
   fi
 
   echo "	insmod gzio" | sed "s/^/$submenu_indentation/"
@@ -218,6 +227,23 @@ prepare_root_cache=
 boot_device_id=
 title_correction_code=
 
+cat << 'EOF'
+function gfxmode {
+	set gfxpayload="${1}"
+EOF
+if [ "$vt_handoff" = 1 ]; then
+  cat << 'EOF'
+	if [ "${1}" = "keep" ]; then
+		set vt_handoff=vt.handoff=1
+	else
+		set vt_handoff=
+	fi
+EOF
+fi
+cat << EOF
+}
+EOF
+
 # Use ELILO's generic "efifb" when it's known to be available.
 # FIXME: We need an interface to select vesafb in case efifb can't be used.
 if [ "x$GRUB_GFXPAYLOAD_LINUX" != x ] || [ "$gfxpayload_dynamic" = 0 ]; then
diff --git a/util/grub.d/10_linux_zfs.in b/util/grub.d/10_linux_zfs.in
index 70f91681e..ec653baa1 100755
--- a/util/grub.d/10_linux_zfs.in
+++ b/util/grub.d/10_linux_zfs.in
@@ -23,6 +23,7 @@ ubuntu_recovery="@UBUNTU_RECOVERY@"
 quiet_boot="@QUIET_BOOT@"
 quick_boot="@QUICK_BOOT@"
 gfxpayload_dynamic="@GFXPAYLOAD_DYNAMIC@"
+vt_handoff="@VT_HANDOFF@"
 
 . "${pkgdatadir}/grub-mkconfig_lib"
 
@@ -694,6 +695,23 @@ END {
 # Note:
 #   If 10_linux runs these part will be defined twice in grub configuration
 print_menu_prologue() {
+    cat << 'EOF'
+function gfxmode {
+	set gfxpayload="${1}"
+EOF
+    if [ "${vt_handoff}" = 1 ]; then
+        cat << 'EOF'
+	if [ "${1}" = "keep" ]; then
+		set vt_handoff=vt.handoff=1
+	else
+		set vt_handoff=
+	fi
+EOF
+    fi
+    cat << EOF
+}
+EOF
+
     # Use ELILO's generic "efifb" when it's known to be available.
     # FIXME: We need an interface to select vesafb in case efifb can't be used.
     GRUB_GFXPAYLOAD_LINUX="${GRUB_GFXPAYLOAD_LINUX:-}"
@@ -775,7 +793,7 @@ zfs_linux_entry () {
 
     if ([ "${ubuntu_recovery}" = 0 ] || [ "${type}" != "recovery" ]) && \
         ([ "${GRUB_GFXPAYLOAD_LINUX}" != "" ] || [ "${gfxpayload_dynamic}" = 1 ]); then
-        echo "	set gfxpayload=\${linux_gfx_mode}" | sed "s/^/${submenu_indentation}/"
+        echo "	gfxmode \${linux_gfx_mode}" | sed "s/^/${submenu_indentation}/"
     fi
 
     echo "	insmod gzio" | sed "s/^/${submenu_indentation}/"
@@ -848,6 +866,14 @@ generate_grub_menu() {
         GRUB_CMDLINE_LINUX_RECOVERY="${GRUB_CMDLINE_LINUX_RECOVERY} nomodeset"
     fi
 
+    if [ "${vt_handoff}" = 1 ]; then
+        for word in ${GRUB_CMDLINE_LINUX_DEFAULT}; do
+            if [ "${word}" = splash ]; then
+                GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT} \${vt_handoff}"
+            fi
+        done
+    fi
+
     print_menu_prologue
 
     # IFS is set to TAB (ASCII 0x09)
